{% extends 'admin/base.twig' %}
{% block stylesheets %}
<!-- DataTables -->
<link rel="stylesheet"
    href="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css')}}">
<link rel="stylesheet"
    href="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css')}}">
<link rel="stylesheet"
    href="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-buttons/css/buttons.bootstrap4.min.css')}}">
{% endblock %}
{% block content %}
<!-- Content Wrapper. Contains page content -->
<title>Data table</title>
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Report
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">Items</a></li>

                        <li class="breadcrumb-item active">Report</li>
                    </ol>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>
    <!-- Main content -->
    <section class="content p-0 p-sm-2">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ค้นหาจาก</h3>

                        </div>
                        <form action="" id="find">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label" for="dateFrom">วันที่จาก</label>
                                        <input class="form-control " type="date" name="dateFrom" id="dateFrom">
                                    </div>
                                    <div class="col">
                                        <label class="form-label" for="dateTo">ถึง</label>
                                        <input class="form-control" type="date" name="dateTo" id="dateTo">
                                    </div>
                                    <div class="col d-flex align-items-end">
                                        <button class="btn btn-primary" type="button" id="findBtn">ค้นหา</button>
                                    </div>
                                </div>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid p-0 p-sm-2">
            <div class="row">
                <div class="col-12">

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Report Items</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body table-responsive p-2 p-sm-3">
                            <div class="row">
                                <div class="col d-flex justify-content-end">
                                    <button class="btn btn-primary" data-bs-toggle='modal'
                                        data-bs-target='#formEditModal'>เพิ่มสินค้า</button>
                                </div>
                            </div>
                            <table id="example1"
                                class="table table-bordered table-striped table-sm text-center table-hover">
                                <thead>
                                    <tr>
                                        <th>id</th>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Number</th>
                                        <th>วันที่สร้าง</th>
                                        <th style='width:50px'>แก้ไข</th>
                                        <th style='width:50px'>ลบ</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>

<!-- /.content-wrapper -->


<div class="modal fade" id="formEditModal" aria-hidden="true" aria-labelledby="formEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateFormTitle">เพิ่มสินค้าใหม่</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" id="updateForm" method="POST" enctype='multipart/form-data'>
                    <input hidden class="form-control" type="text" id="rowId" name="rowId">
                    <label for="name" class="form-label">ชื่อ</label>
                    <input class="form-control" type="text" id="name" name="name">
                    <label for="description">รายละเอียด</label>
                    <textarea class="form-control" name="description" id="description" cols="30" rows="5"></textarea>
                    <label for="description">ราคา</label>
                    <input class="form-control" type="number" name="numberValue" id="numberValue">

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="confirmBtn">ยืนยัน</button>
                <button class="btn btn-outline-tritary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<!-- DataTables  -->
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables/jquery.dataTables.min.js')}}"></script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js')}}">
</script>
<script
    src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-responsive/js/dataTables.responsive.min.js')}}">
</script>
<script
    src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-responsive/js/responsive.bootstrap4.min.js')}}">
</script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-buttons/js/dataTables.buttons.min.js')}}">
</script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-buttons/js/buttons.bootstrap4.min.js')}}">
</script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/jszip/jszip.min.js')}}"></script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/pdfmake/pdfmake.min.js')}}"></script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/pdfmake/vfs_fonts.js')}}"></script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-buttons/js/buttons.html5.min.js')}}">
</script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-buttons/js/buttons.print.min.js')}}">
</script>
<script src="{{assetUrl('/vendor/almasaeed2010/adminlte/plugins/datatables-buttons/js/buttons.colVis.min.js')}}">
</script>

<script>
    var table;
    $(function () {
        var currentDate = new Date();
        currentDate.setDate(1);
        var formattedDate = currentDate.toISOString().split('T')[0];
        $("#dateFrom").val(formattedDate);
        document.getElementById("dateTo").valueAsDate = new Date();
        //table = loadDataTable('#example1', '/my-slim/items');
        $("#findBtn").on('click', function () {
            var dateFrom = $("#dateFrom").val();
            var dateTo = $("#dateTo").val();
            url = '/my-slim/items?dateFrom=' + dateFrom + '&dateTo=' + dateTo;
            table = loadDataTable("#example1", url);
        });
        $("#findBtn").click();

        $("#example1 tbody").on('click', '.my-edit', function () {
            var row = $(this).closest('tr');
            var data = table.row(row).data();
            $("#updateFormTitle").html("แก้ไขรายการที่ " + data.id);
            $("#rowId").val(data.id);
            $("#name").val(data.name);
            $("#description").val(data.description);
            $("#numberValue").val(data.numberValue);
        });
        $("#example1 tbody").on('click', '.my-delete', function () {
            var row = $(this).closest('tr');
            var data = table.row(row).data();

            Swal.fire({
                title: "ลบข้อมูล id:" + data.id,
                icon: "warning",
                showCloseButton: true,
                showCancelButton: true,
                confirmButtonText: "ลบ",
                cancelButtonText: "ยกเลิก",
                showDenyButton: true,
                showConfirmButton: false,
                denyButtonText: "ลบ"
            }).then((result) => {
                if (result.isDenied) {
                    $.ajax({
                        type: 'DELETE',
                        url: '/my-slim/items/' + data.id,
                        contentType: 'application/json',
                        success: function (response) {
                            console.log("response", response);
                            Swal.fire({
                                title: "Deleted!",
                                text: "Your file has been deleted.",
                                icon: "success",
                                showConfirmButton: false,
                                showCloseButton: true,
                                timer: 1500
                            });
                            $("#mainForm").trigger("reset");
                            $("#findBtn").click();
                        },
                        error: function (error) {
                            errorJSON = JSON.parse(error.responseText);
                            console.error("error", errorJSON);
                            Swal.fire({
                                title: "ไม่สำเร็จ",
                                text: errorJSON.error.description,
                                showCloseButton: true,
                                showConfirmButton: false,
                                icon: "error"
                            });
                        }
                    })
                }
            });
        })
        $("#confirmBtn").on('click', function () {
            var formData = {
                name: $('#name').val(),
                description: $('#description').val(),
                numberValue: $('#numberValue').val()
            };
            var jsonData = JSON.stringify(formData);

            var id = $("#rowId").val();
            var type, url;
            if (id == '') {
                type = 'POST';
                url = '/my-slim/items';
            } else {
                type = 'PUT';
                url = '/my-slim/items/' + id;

            }
            $.ajax({
                type: type,
                url: url,
                contentType: 'application/json',
                data: jsonData,
                success: function (response) {
                    console.log("response", response);
                    Swal.fire({
                        title: "บันทึกสำเร็จ",
                        text: response.data.message + " id:" +
                            response
                            .data.id,
                        showCloseButton: true,
                        showConfirmButton: false,
                        icon: "success",
                        timer: 1500
                    });
                    $("#mainForm").trigger("reset");
                    $("#findBtn").click();
                    $('#formEditModal').modal('hide');
                },
                error: function (error) {
                    errorJSON = JSON.parse(error.responseText);
                    console.error("error", errorJSON);
                    Swal.fire({
                        title: "ไม่สำเร็จ",
                        text: errorJSON.error.description,
                        showCloseButton: true,
                        showConfirmButton: false,
                        icon: "error"
                    });
                    $('#formEditModal').modal('hide');
                }
            });

        });
        $('#formEditModal').on('hidden.bs.modal', function () {
            $("#updateForm").trigger("reset");
            $("#updateFormTitle").html("เพิ่มสินค้าใหม่");
        });
    });

    function loadDataTable(tableId, url) {
        $(tableId).DataTable().destroy();
        return new DataTable(tableId, {
            ajax: url,
            columns: [{
                    data: 'id'
                }, {
                    data: 'name'
                },
                {
                    data: 'description'
                },
                {
                    data: 'numberValue'
                },
                {
                    data: 'created_at'
                },
                {
                    data: null,
                    "render": function (data, type, row, meta) {
                        return "<button type='button' class='btn btn-sm btn-outline-primary my-edit' id='btn-edit-" +
                            meta.row +
                            "' data-bs-toggle='modal' data-bs-target='#formEditModal'>Edit</button>";
                    },
                    orderable: false

                }, {
                    data: null,
                    "render": function (data, type, row, meta) {
                        return "<button type='button' class='btn btn-sm btn-outline-danger my-delete' id='btn-delete-" +
                            meta.row +
                            "' >Delete</button>";
                    },
                    orderable: false

                }

            ],
            "responsive": true,
            "lengthChange": true,
            "autoWidth": false,
            deferRender: true,
            stateSave: true,
            dom: "<'row'<'col-12 text-center'B>>" +
                "<'row'<'col-6 d-flex justify-content-start'l><'col-6 d-flex justify-content-end'f>> " +
                "<'row'<'col-sm-12 col-md-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p >> ",
            language: {
                "search": "ค้นหา",
                "lengthMenu": "โชว์ _MENU_ ",
            },
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
        });


    }
</script>
{% endblock %}